# ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
# »› Developed by Foxx
# »› Copyright © 2024 Aurel Hoxha. All rights reserved.
# »› GitHub: https://github.com/TeamFoxx
# »› For support and inquiries, please contact info@aurelhoxha.de
# »› Use of this program is subject to the terms the terms of the MIT licence.
# »› A copy of the license can be found in the "LICENSE" file in the root directory of this project.
# ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
#
# ⏤ { imports } ⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤
import json
import logging
from pathlib import Path

import discord
from discord import Modal, ActionRow, TextInput
from discord.ext import commands

# ⏤ { configurations } ⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤

user_data = {}
counting_file_path = "data/counting.json"


# ⏤ { function definitions } ⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤
def load_language(user_id):
    # Define user language and load language data
    user_info = user_data.get(user_id, {})
    user_language = user_info.get('user_language', 'en')
    script_directory = Path(__file__).resolve().parent.parent.parent
    file_path = script_directory / "languages/confirm_purchase_language_file.json"
    language = load_language_data(file_path, user_language)
    return language


def load_language_data(file_path: Path, user_language: str) -> dict:
    """
    Loads the language data from the specified file and selects the language based on user_language.
    Returns the language dictionary if found, otherwise returns an empty dictionary.
    """
    try:
        with open(file_path, "r", encoding="utf-8") as file:
            language_data = json.load(file)
            if user_language in language_data:
                return language_data[user_language]
            else:
                logging.warning(f"Language '{user_language}' not found in language file.")
                return {}
    except FileNotFoundError:
        logging.error(f"Language file '{file_path}' not found.")
        return {}


def load_counting():
    """
    Loads the counting value from the file if it exists, otherwise returns 0.
    """
    try:
        with open(counting_file_path, "r") as file:
            return int(file.read())
    except FileNotFoundError:
        return 0


def save_counting(counting):
    """
    Saves the counting value to the file.
    """
    with open(counting_file_path, "w") as file:
        file.write(str(counting))


# ⏤ { settings } ⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤

logging.basicConfig(filename='bot.log', level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')


class ProductPurchaseConfirmation(commands.Cog):
    def __init__(self, bot):
        self.bot: commands.Bot = bot
        self.order_product_channel_id = 1216178294458814526
        self.official_staff_id = 1216137762537996479

# ⏤ { codebase } ⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤

    @commands.Cog.slash_command(
        name="confirm-product-purchase",
        description='Send confirmation message for product purchase.',
        default_required_permissions=discord.Permissions(administrator=True)
    )
    async def send_confirmation_of_product_purchase(self, ctx):
        # Extract user ID from the interaction context
        user = ctx.author

        # Load selected language
        language = load_language(user.id)

        # Define the modal with input fields for bot name and status
        modal = Modal(
            title=language["modal_title"],
            custom_id=f'confirm_product_purchase',
            components=[
                ActionRow(
                    TextInput(
                        label=language["customer_name_modal_lable"],
                        placeholder=language["customer_name_modal_placeholder"],
                        custom_id='customer_name',
                        required=True,
                        style=1,
                        max_length=26,
                    )
                ),
                ActionRow(
                    TextInput(
                        label=language["discord_user_id_modal_lable"],
                        placeholder=language["discord_user_id_modal_placeholder"],
                        custom_id='discord_user_id',
                        required=True,
                        style=1,
                        min_length=17,
                        max_length=18,
                    )
                ),
                ActionRow(
                    TextInput(
                        label=language["product_type_modal_lable"],
                        placeholder=language["product_type_modal_placeholder"],
                        custom_id='product_type',
                        required=True,
                        style=2
                    )
                ),
                ActionRow(
                    TextInput(
                        label=language["product_price_modal_lable"],
                        placeholder=language["product_price_modal_placeholder"],
                        custom_id='product_price',
                        required=True,
                        style=1,
                        max_length=4,
                    )
                ),
                ActionRow(
                    TextInput(
                        label=language["discount_modal_lable"],
                        placeholder=language["discount_modal_placeholder"],
                        custom_id='discount_value',
                        required=True,
                        style=1,
                        max_length=2,
                    )
                )
            ]
        )

        # Respond to the interaction with the modal
        await ctx.respond_with_modal(modal)


# ⏤ { settings } ⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤⏤

def setup(reelab_bot):
    reelab_bot.add_cog(ProductPurchaseConfirmation(reelab_bot))
